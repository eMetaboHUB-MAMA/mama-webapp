$(window).on("load",function(){loadLang();if(getUrlParameter("mth_pf")!==undefined){filterMthPF=true;filterMthPFval=getUrlParameter("mth_pf")}buildMTHplatforms();buildRangeDate();buildGraph();$("#link-donwload-xls-file").attr("href",$("#link-donwload-xls-file").attr("href")+document.location.search.replace("?page=statistics",""));if(getUrlParameter("from")===undefined){$("#link-donwload-xls-file").attr("href",$("#link-donwload-xls-file").attr("href")+"&from="+lastYear)}if(getUrlParameter("to")===undefined){$("#link-donwload-xls-file").attr("href",$("#link-donwload-xls-file").attr("href")+"&to="+today)}if(filterMthPF){const b=filterMthPFval.replace(/mth_pf_/g,"").split(",");const a=(b.length>0)?"&isPlatForm="+b.join(","):"";$("#link-donwload-xls-file").attr("href",$("#link-donwload-xls-file").attr("href")+"&isPlatForm="+a)}$("#range-date-update").on("click",function(c){reloadPage()})});function buildRangeDate(){if(getUrlParameter("from")!==undefined){$("#range-date-start").val(getUrlParameter("from"))}else{$("#range-date-start").val(lastYear)}if(getUrlParameter("to")!==undefined){$("#range-date-end").val(getUrlParameter("to"))}else{$("#range-date-end").val(today)}$(".datepicker").datepicker()}var filterMthPF=false;var filterMthPFval="";function addRemoveUserFilter(a,b){if(a=="mth_pf"){filterMthPF=true;filterMthPFval=b}}function reloadPage(){var a="?page=statistics";if($("#range-date-start").val()!=""){a+="&from="+$("#range-date-start").val()}if($("#range-date-end").val()!=""){a+="&to="+$("#range-date-end").val()}if($("#mthPlatforms").val()!=""){a+="&mth_pf="+$("#mthPlatforms").val()}document.location=a}function buildGraph(){var e=$("#range-date-start").val();var d=$("#range-date-end").val();const a=(filterMthPFval!="null"&&filterMthPFval!="");const b=a?filterMthPFval.split(","):[];const c=a?filterMthPFval.replace(/mth_pf_/g,"").split(","):[];setTimeout(function(){buildTabPFxStatus(e,d,b)},10);setTimeout(function(){buildLaboTypeChart(e,d,c)},20);setTimeout(function(){buildCopartnerChart(e,d,c)},30);setTimeout(function(){buildDemandsChart(e,d,c)},40);setTimeout(function(){buildTargetedChart(e,d,c)},60);setTimeout(function(){buildSampleNbChart(e,d,c)},70);setTimeout(function(){buildFinancialChart(e,d,c)},80);setTimeout(function(){buildUserLaboTypeChart(e,d,c)},90);setTimeout(function(){buildExtraLaboTypeChart(e,d,c)},100);setTimeout(function(){buildThematicChart(e,d,c)},110);setTimeout(function(){buildSubThematicChart(e,d,c)},120);setTimeout(function(){buildFundingSourcesChart(e,d,c)},130);setTimeout(function(){buildManagerThematicChart(e,d,c)},140);setTimeout(function(){buildSubPlatforms(e,d,c)},140)}function buildTabPFxStatus(B,f,A){let listOfMthPF=[];$.ajax({type:"get",url:"ajax/ajax_proxypass.php?verbe=get&resource=mth-platforms&order=asc",dataType:"json",async:false,success:function(I){listOfMthPF=(I)},error:function(I){console.log(I)}});$("#statsPjPFxStatus").empty();var D=0;var x=0;var n=0;var w=0;var l=0;var z=0;var t=0;var F=0;var j=0;$.each(listOfMthPF,function(L,K){if(A.length>0&&!A.includes("mth_pf_"+K.id)){return}var O=K.name;var N=K.id;var P=(getNbOf(B,f,"isPlatForm="+N+"&group=status"))[0];var J=P;var M=J.rejected+J.assigned+J.accepted+J.completed+J.running;M+=J.blocked+J.archived+J.waiting;D+=M;J.total=M;var I="<tr>";I+="<td>"+O+"</td>";I+="<td>"+J.rejected+"</td>";I+="<td>"+J.waiting+"</td>";I+="<td>"+J.assigned+"</td>";I+="<td>"+J.completed+"</td>";I+="<td>"+J.accepted+"</td>";I+="<td>"+J.running+"</td>";I+="<td>"+J.blocked+"</td>";I+="<td>"+J.archived+"</td>";I+="<td>"+J.total+"</td>";I+="</tr>";$("#statsPjPFxStatus").append(I)});var d=(getNbOf(B,f,"&isStatus=&isNotStatus=&group=status"))[0];var g=0;var q=d;var g=q.rejected+q.assigned+q.accepted+q.completed+q.running;g+=q.blocked+q.archived+q.waiting;q.total=g;var i=(getNbOf(B,f,"isStatus=rejected&isNotStatus=&group=mthPF"));var s=(getNbOf(B,f,"isStatus=waiting&isNotStatus=&group=mthPF"));var h=(getNbOf(B,f,"isStatus=assigned&isNotStatus=&group=mthPF"));var E=(getNbOf(B,f,"isStatus=accepted&isNotStatus=&group=mthPF"));var u=(getNbOf(B,f,"isStatus=completed&isNotStatus=&group=mthPF"));var v=(getNbOf(B,f,"isStatus=running&isNotStatus=&group=mthPF"));var r=(getNbOf(B,f,"isStatus=blocked&isNotStatus=&group=mthPF"));var C=(getNbOf(B,f,"isStatus=archived&isNotStatus=&group=mthPF"));var p=extractFromRaw(i);var c=extractFromRaw(s);var o=extractFromRaw(h);var a=extractFromRaw(E);var G=extractFromRaw(u);var e=extractFromRaw(v);var b=extractFromRaw(r);var H=extractFromRaw(C);var k=(p+c+o+a+G+e+b+H);var y="<tr>";y+='<td><span style="display: none">Åº</span>NONE</td>';y+="<td>"+(p)+"</td>";y+="<td>"+(c)+"</td>";y+="<td>"+(o)+"</td>";y+="<td>"+(G)+"</td>";y+="<td>"+(a)+"</td>";y+="<td>"+(e)+"</td>";y+="<td>"+(b)+"</td>";y+="<td>"+(H)+"</td>";y+="<td>"+(k)+"</td>";y+="</tr>";$("#statsPjPFxStatus").append(y);var m="<tr>";m+="<td>Total (no filter)</td>";m+="<td>"+(q.rejected)+"</td>";m+="<td>"+(q.waiting)+"</td>";m+="<td>"+(q.assigned)+"</td>";m+="<td>"+(q.completed)+"</td>";m+="<td>"+(q.accepted)+"</td>";m+="<td>"+(q.running)+"</td>";m+="<td>"+(q.blocked)+"</td>";m+="<td>"+(q.archived)+"</td>";m+="<td>"+(q.total)+"</td>";m+="</tr>";$("#statsPjPFxStatusFooter").empty();$("#statsPjPFxStatusFooter").append(m);$("#statsPjPFxStatusTable").tablesorter();$("#span-count-nb-rejected-projects").html(q.rejected)}function extractFromRaw(a){if((a[0])!==undefined&&(a[0]).pf_ids===null){return(a[0]).projects_count}else{if((a).pf_ids===null){return(a).projects_count}}return 0}function buildUserLaboTypeChart(f,e,d){const c=(d.length>0)?"&isPlatForm="+d.join(","):"";const b=(getNbOf(f,e,c+"&group=laboratory","users-statistics"))[0];var a=[{name:"Laboratory",colorByPoint:true,data:[{name:"Private",y:b.u_labo_private},{name:"Public",y:b.u_labo_public},{name:"Public / Private",y:b.u_labo_public_private}]}];buildGenericPie("#container-pie-usersLabo"," active users laboratories profiles ",a)}function buildExtraLaboTypeChart(f,e,d){const c=(d.length>0)?"&isPlatForm="+d.join(","):"";const b=(getNbOf(f,e,c+"&group=laboratory","extra-data-statistics"))[0];var a=[{name:"Laboratory",colorByPoint:true,data:[{name:"Private",y:b.e_labo_private},{name:"Public",y:b.e_labo_public},{name:"Public / Private",y:b.e_labo_public_private}]}];buildGenericPie("#container-pie-extraLabo"," projects laboratories profiles ",a)}function buildLaboTypeChart(g,h,d){const c=(d.length>0)?"&isPlatForm="+d.join(","):"";const b=c+"&isStatus=waiting,accepted,assigned,completed,running,archived&isOwner=";const e=(getNbOf(g,h,b+"public"))[0].projects_count;const f=(getNbOf(g,h,b+"private"))[0].projects_count;const i=(getNbOf(g,h,b+"public_private"))[0].projects_count;const a=[{name:"Laboratory",colorByPoint:true,data:[{name:"Private",y:f},{name:"Public",y:e},{name:"Public / Private",y:i}]}];buildGenericPie("#container-pie-laboratory"," project's laboratories profiles ",a)}function buildCopartnerChart(g,h,e){const d=(e.length>0)?"&isPlatForm="+e.join(","):"";var a=getNbOf(g,h,d+"&isStatus=waiting,accepted,assigned,completed,running,archived&group=copartner")[0];var f=a.can_be_fwd;var i=a.can_not_be_fwd;var c=a.undef;var b=[{name:"Forward",colorByPoint:true,data:[{name:"Can be Fwd",y:f},{name:"Can't be Fwd",y:i},{name:"Undefinded",y:c}]}];buildGenericPie("#container-pie-copartner"," can be forwarded to Copartner ",b)}function buildDemandsChart(i,j,f){const e=(f.length>0)?"&isPlatForm="+f.join(","):"";var a=getNbOf(i,j,e+"&isStatus=waiting,accepted,assigned,completed,running,archived&group=type")[0];var l=a.dt__eqprov;var b=a.dt__catallo;var g=a.dt__feastu;var k=a.dt__train;var h=a.dt__data_proc;var d=a.dt__other;var c=[{name:"Demands",colorByPoint:true,data:[{name:"Equipment provisioning",y:l},{name:"Catalog allowance - lab routine",y:b},{name:"feasibility study - R & D",y:g},{name:"Training",y:k},{name:"Data processing",y:h},{name:"Other",y:d}]}];buildGenericPie("#container-pie-demand"," Demand type ",c)}function buildTargetedChart(h,i,f){const d=(f.length>0)?"&isPlatForm="+f.join(","):"";var a=getNbOf(h,i,d+"&isStatus=waiting,accepted,assigned,completed,running,archived&group=targeted")[0];var g=a.is_targeted;var e=a.is_NOT_targeted;var b=a.undef;var c=[{name:"Targeted",colorByPoint:true,data:[{name:"targeted",y:g},{name:"untargeted",y:e},{name:"undefined",y:b}]}];buildGenericPie("#container-pie-targeted"," Targeted ",c)}function buildSampleNbChart(j,k,i){const g=(i.length>0)?"&isPlatForm="+i.join(","):"";var a=getNbOf(j,k,g+"&isStatus=waiting,accepted,assigned,completed,running,archived&group=sample_number")[0];var d=a.less_50;var b=a["51_to_100"];var c=a["101_to_500"];var e=a.more_501;var h=a.undef;var f=[{name:"sampleNb",colorByPoint:true,data:[{name:"50 or less",y:d},{name:"51  to 100",y:b},{name:"101 to 500",y:c},{name:"more than 501",y:e},{name:"undefined",y:h}]}];buildGenericPie("#container-pie-sampleNb"," Sample Number ",f)}function buildFinancialChart(i,j,h){const g=(h.length>0)?"&isPlatForm="+h.join(","):"";const a=getNbOf(i,j,g+"&isStatus=waiting,accepted,assigned,completed,running,archived&group=financial")[0];var c=a.f__financed;var d=a.f__provisioning;var e=a.f__ownsupply;var b=a.f__notfinanced;var f=[{name:"funding",colorByPoint:true,data:[{name:"financed",y:c},{name:"provisioning",y:d},{name:"on own supply",y:e},{name:"Not financed",y:b}]}];buildGenericPie("#container-pie-funding"," Funding ",f)}function buildThematicChart(g,f,e){const d=(e.length>0)?"&isPlatForm="+e.join(","):"";const c=(getNbOf(g,f,d+"&group=keywords&isStatus=waiting,accepted,assigned,completed,running,archived","projects-statistics"));var b=[];$.each(c,function(i,h){if(h.tw_words!==null){b.push({name:h.tw_words,y:h.projects_count})}});var a=[{name:"Thematic keyword",colorByPoint:true,data:b}];buildGenericPie("#container-pie-thematic"," Projects thematic repartition ",a)}function buildSubThematicChart(g,f,e){const d=(e.length>0)?"&isPlatForm="+e.join(","):"";const c=(getNbOf(g,f,d+"&group=subkeywords&isStatus=waiting,accepted,assigned,completed,running,archived","projects-statistics"));var b=[];$.each(c,function(i,h){if(h.tw_words!==null){b.push({name:h.tw_words,y:h.projects_count})}});var a=[{name:"Sub-thematic keyword",colorByPoint:true,data:b}];buildGenericPie("#container-pie-subthematic"," Projects sub-thematic repartition ",a)}function getNbOf(f,e,c,b){var d=-1;var a=b;if(b===undefined){a="projects-statistics"}$.ajax({type:"get",url:"ajax/ajax_proxypass.php?verbe=get&resource="+a+"&from="+f+"&to="+e+"&"+c,dataType:"json",async:false,success:function(g){if(!(g.hasOwnProperty("success")&&g.success==false)){d=g}},error:function(g){console.log(g)}});return d}function buildGenericPie(a,c,b){$(a).highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,type:"pie"},title:{text:c},tooltip:{pointFormat:"<b>{point.percentage:.2f}%</b> ({point.y})",useHTML:true},plotOptions:{pie:{allowPointSelect:true,cursor:"pointer",dataLabels:{enabled:true,format:"<b>{point.name}</b>: {point.percentage:.1f}% ({point.y})",style:{color:(Highcharts.theme&&Highcharts.theme.contrastTextColor)||"black"},useHTML:true}}},series:b})}var _start_pj_display=0;var _max_pj_display=20;function openStatsRejectedProjects(){var b=$("#range-date-start").val();var a=$("#range-date-end").val();_start_pj_display=0;$("#tab-stats-pj-rejected tbody").empty();$("#_stats_pj_rejected_date_start").html(b);$("#_stats_pj_rejected_date_end").html(a);$("#btn-stats-rejected-projects-xls-dnl").attr("href",$("#btn-stats-rejected-projects-xls-dnl").attr("href")+document.location.search.replace("?page=statistics","")+"&status=rejected&from="+b+"&to="+a);showStatsRejectedProjects()}function showStatsRejectedProjects(){var c=$("#range-date-start").val();var a=$("#range-date-end").val();var d="get";var b="projects";$.ajax({type:"get",url:"ajax/ajax_proxypass.php?verbe="+d+"&resource="+b,dataType:"json",data:"start="+_start_pj_display+"&limit="+_max_pj_display+"&status=rejected&from="+c+"&to="+a+"&order=asc",async:true,success:function(e){if((e).hasOwnProperty("success")&&e.success==false){return false}$.each(e,function(i,j){var h="";$.each(j.mthPlatforms,function(l,k){h+='<span class="demandTypeEqProvisioning label label-default label-space" style="display: inline;">'+k.name+"</span>"});var f="<code>";if(j.analysisRequestExtraData){switch(j.analysisRequestExtraData.rejectedReason){case"too_expensive":f+=(_modal_stopProject_rejectedSelect_opt_expensive);break;case"too_long_delays":f+=(_modal_stopProject_rejectedSelect_opt_delays);break;case"outside_our_skill_sphere":f+=(_modal_stopProject_rejectedSelect_opt_outside_our_skill);break;case"non_prioritary_rad":f+=(_modal_stopProject_rejectedSelect_opt_non_prioritary);break;case"incompatible_deadline":f+=(_modal_stopProject_rejectedSelect_opt_incompatible_deadline);break;case"too_many_samples":f+=(_modal_stopProject_rejectedSelect_opt_too_many_samples);break;case"transfered_to_privilegied_mth_partner":f+=(_modal_stopProject_rejectedSelect_opt_transfered_to_privilegied);break;case"not_funded":f+=(_modal_stopProject_rejectedSelect_opt_not_funded);break;case"saved_twice":f+=(_modal_stopProject_rejectedSelect_opt_saved_twice);break;case"canceled_by_client":f+=(_modal_stopProject_rejectedSelect_opt_canceled_by_client);break}}f+="</code>";var g='<tr><td><a href="?page=edit-project&editProject='+j.id+'">'+j.idLong+"</a></td><td>"+j.title+"</td><td>"+h+"</td><td>"+f+"</td></tr>";$("#tab-stats-pj-rejected tbody").append(g)});_start_pj_display+=_max_pj_display;if(e.length===_max_pj_display){$("#btn-show-more-rejected-project").show()}else{$("#btn-show-more-rejected-project").hide()}$("#statsProjectsModal").modal("show")},error:function(e){console.log(e)}})}function buildFundingSourcesChart(l,m,i){const h=(i.length>0)?"&isPlatForm="+i.join(","):"";const a=getNbOf(l,m,h+"&isStatus=waiting,accepted,assigned,completed,running,archived&group=financial_type")[0];var f=a.fs__eu;var c=a.fs__anr;var b=a.fs__national;var d=a.fs__regional;var n=a.fs__compagny_tutorship;var k=a.fs__international_outside_eu;var e=a.fs__own_resources_laboratory;var j=a.fs__other;var g=[{name:"funding sources",colorByPoint:true,data:[{name:"EU",y:f},{name:"ANR",y:c},{name:"National",y:b},{name:"Regional",y:d},{name:"Compagny Tutorship",y:n},{name:"International Outside EU",y:k},{name:"Own Resources Laboratory",y:e},{name:"Other",y:j}]}];buildGenericPie("#container-pie-financial_type"," Fundings sources ",g)}function buildManagerThematicChart(g,f,e){const d=(e.length>0)?"&isPlatForm="+e.join(","):"";const c=(getNbOf(g,f,d+"&group=manager-keywords&isStatus=waiting,accepted,assigned,completed,running,archived","projects-statistics"));var b=[];$.each(c,function(i,h){if(h.tw_words!==null){b.push({name:h.tw_words,y:h.projects_count})}});var a=[{name:"Manager-thematic keyword",colorByPoint:true,data:b}];buildGenericPie("#container-pie-manager-thematic"," Projects manager-thematic repartition ",a)}function buildSubPlatforms(g,f,e){const d=(e.length>0)?"&isPlatForm="+e.join(","):"";const c=(getNbOf(g,f,d+"&group=mth-sub-platforms&isStatus=waiting,accepted,assigned,completed,running,archived","projects-statistics"));var b=[];$.each(c,function(i,h){if(h.sub_pf_names!==null){b.push({name:h.sub_pf_names,y:h.projects_count})}else{if(h.sub_pf_names===null){b.push({name:"none",y:h.projects_count})}}});var a=[{name:"MTH Sub-Platform",colorByPoint:true,data:b}];buildGenericPie("#container-pie-sub-platforms"," Projects Sub-Platform",a)};