var nbAppointment=0;var currentStart=0;var currentLimit=20;var currentKeyword=null;var currentFilter=null;var currentAppointmentId=null;$(document).ready(function(){loadLang();if(getUrlParameter("keyword")!==undefined){currentKeyword=getUrlParameter("keyword");$("#appointmentsSearchFilter").val(currentKeyword)}if(getUrlParameter("start")!==undefined){currentStart=getUrlParameter("start")}if(getUrlParameter("limit")!==undefined){currentLimit=getUrlParameter("limit")}if(getUrlParameter("filter")!==undefined&&getUrlParameter("filter")!="null"){currentFilter=getUrlParameter("filter");$("#search-appointments-filter-dest").html($("#search-appointments-filter-"+currentFilter).text())}loadAppointmentsStats();$.get("templates/appointments-full-list-template-"+lang+".html",function(a){$("body").append(a);loadAppointmentsList(currentStart,currentLimit,"")});if(!(userData.right=="admin"||userData.right=="project_manager")){$("#btn-userFilter-inCharge").hide();$("#btn-userFilter-involved").hide()}$("#appointmentModal_linkToAppointment").hide();$("#appointmentsSearchFilter").bind("keypress",function(b){var a=b.keyCode||b.which;if(a==13){searchAppointments()}})});function loadAppointmentsStats(){var d="get";var b="appointments-count";var a="";var c=false;if(currentKeyword!=null){a+="&keywords="+currentKeyword;c=true}if(currentFilter!=null){a+="&filter="+currentFilter;c=true}$.ajax({type:"get",url:"ajax/ajax_proxypass.php?verbe="+d+"&resource="+b+a,dataType:"json",async:true,success:function(e){if(e.hasOwnProperty("success")&&e.success==false){}else{nbAppointment=e;if(nbAppointment==0&&!c){$("#noAppointmentsContent").show();$(".listAppointmentsContent").hide()}}},error:function(e){console.log(e)}})}function loadAppointmentsList(g,a,b){$("#appointments-full-list-container").empty();var f="get";var d="appointments";var e=false;var c="&start="+g+"&limit="+a;if(b!==undefined&&b!==null){c+="&filter="+b;e=true}if(currentKeyword!=null){c+="&keywords="+currentKeyword;e=true}if(currentFilter!=null){c+="&filter="+currentFilter;e=true}c+="&order=desc";$.ajax({type:"get",url:"ajax/ajax_proxypass.php?verbe="+f+"&resource="+d+c,dataType:"json",async:true,success:function(i){if(i.hasOwnProperty("success")&&i.success==false){}else{if(i.length===0&&!e){$("#noAppointmentsDiv").show();$("#tableListAppointments").hide()}else{$("#noAppointmentsDiv").hide();$.each(i,function(){if(this.fromUser!==null){var l=md5(this.fromUser.email.toLowerCase());var j=("https://secure.gravatar.com/avatar/"+l+"?s=25&d=identicon");this.fromUser.avatar=j;if(this.fromUser.email==userData.email){this.fromUser.id=null}else{this.fromUser.phoneDial=formatPhoneDial(this.fromUser.phoneGroup,this.fromUser.phoneNumber);this.fromUser.phoneDisplay=formatPhoneDisplay(this.fromUser.phoneGroup,this.fromUser.phoneNumber)}}if(this.toUser!==null){var l=md5(this.toUser.email.toLowerCase());var j=("https://secure.gravatar.com/avatar/"+l+"?s=25&d=identicon");this.toUser.avatar=j;if(this.toUser.email==userData.email){this.toUser.id=null}else{this.toUser.phoneDial=formatPhoneDial(this.toUser.phoneGroup,this.toUser.phoneNumber);this.toUser.phoneDisplay=formatPhoneDisplay(this.toUser.phoneGroup,this.toUser.phoneNumber)}}this["message"]=$("<div>").append(this.message).text();this["dateToChoose"]="";if(this.appointmentDate!=null){this["dateToChoose"]=convertJsonDateToHumanReadable(this.appointmentDate.date).substring(0,16)}else{var k=0;$.each(this.appointmentDatesPropositions,function(n,m){if(m.appointmentSelected==null){k++}});this["dateToChoose"]=_appointmentChooseDatePrefix+k+_appointmentChooseDateSuffix}this["createdLocalDate"]=convertJsonDateToHumanReadable(this.created.date)});$("#appointments-full-list-template").tmpl(i).appendTo("#appointments-full-list-container");var h=nbAppointment;if(h>a){buildPagination(g,a,b,"appointmentsPagination","loadAppointmentsList",h)}}}},error:function(h){console.log(h)}})}reloadPage=function(a){var b="?page=appointments";if(a!==undefined){b+="&filter="+a}else{if(currentFilter!==null){b+="&filter="+currentFilter}}if($("#appointmentsSearchFilter").val().trim()!=""){b+="&keyword="+$("#appointmentsSearchFilter").val().trim()}document.location=b};searchAppointments=function(){reloadPage(currentFilter)};